# Cap

> https://app.hackthebox.com/machines/Cap

<img width="1006" height="362" alt="capa" src="https://github.com/user-attachments/assets/04dda38b-10a8-42d3-b669-dd3d10b89b1a" />

## Table of Contents

* [About](#about)
* [References](#references)
* [Reconnaissance](#reconnaissance)
* [IDOR](#idor)
* [SSH Access](#ssh-access)
* [Privilege Escalation](#privilege-escalation)
* [Conclusion](#conclusion)

## About

Cap is an easy-difficulty Linux machine running an HTTP server that performs administrative functions including network packet captures. Improper access controls result in an Insecure Direct Object Reference (IDOR) vulnerability, exposing another user's capture. The capture contains plaintext FTP credentials that can be used to gain a foothold. A Linux capability is then leveraged to escalate privileges to root.

## References

* [Gunicorn](https://gunicorn.org/)
* [Man Pages - Capabilities](https://www.man7.org/linux/man-pages/man7/capabilities.7.html)
* [GTFOBins - Python Capabilities](https://gtfobins.github.io/gtfobins/python/#capabilities)
* [Earthly - Introduction to Capabilities](https://earthly.dev/blog/intro-to-linux-capabilities/)
* [FTP - Plaintext Credentials and Data](https://dohost.us/index.php/2025/08/04/the-major-security-flaw-of-ftp-plaintext-credentials-and-data/)
* [IDOR - Insecure Direct Object Reference](https://portswigger.net/web-security/access-control/idor)

## Reconnaissance

Nmap revealed three open TCP ports:

* __21__ - vsftpd 3.0.3
* __22__ - OpenSSH 8.2p1 Ubuntu
* __80__ - Gunicorn

<img width="1904" height="547" alt="0" src="https://github.com/user-attachments/assets/51c8c025-06d5-40ce-aef4-9b0981a91cc1" />

Accessing the web server presented a __Security Dashboard__ displaying metrics for Security Events, Failed Login Attempts, and Port Scans (Unique IPs).

The application initially exposed 4 routes: __/capture__, __/ip__, __/netstat__ and __/data/<id\>__

<img width="1920" height="1057" alt="1" src="https://github.com/user-attachments/assets/ec0b9916-e1b7-4767-a1db-b4df814dd7cf" />

## IDOR

The __/data/\<id\>__ route was vulnerable to IDOR. By manipulating the ID parameter in the request, I could access packet capture reports generated by other users. Since the IDs were sequential (0 through 6 at the time of testing), I iterated through the reports and downloaded all _.pcap_ files for local analysis.

<img width="1918" height="1058" alt="2" src="https://github.com/user-attachments/assets/0695f0bf-12a4-4b78-afdd-4034075fbe91" />
<img width="1920" height="584" alt="3" src="https://github.com/user-attachments/assets/b02d6e98-3200-496c-b61d-c57fbfa7f61f" />

## SSH Access

Analysis of __data/0.pcap__ revealed sensitive information. Because the machine was not running FTPS or SFTP, the capture file contained plaintext FTP credentials for the __nathan__ user, which I used to SSH login to the machine as __nathan__ and retrieve the user flag.

<img width="1920" height="1057" alt="4" src="https://github.com/user-attachments/assets/9741a2e3-bee3-45ec-acde-447aa9fb9adc" />

<img width="1107" height="411" alt="5" src="https://github.com/user-attachments/assets/1365d382-2dd9-40fe-85f9-3522d19aa462" />

## Privilege Escalation

As with most HackTheBox machines, the box name provides a hint about an aspect of the challenge, in this case, __Cap__ suggests _Linux Capabilities_.

I iterated through directories in the `$PATH` environment variable and ran `getcap -r` on each. The __/usr/bin__ directory contained four binaries with capabilities, three of which were default: __ping__, __traceroute6.iputils__, and __mtr-packet__.

* __/usr/bin/python3.8__ = _cap_setuid,cap_net_bind_service+eip_
* __/usr/bin/ping__ = _cap_net_raw+ep_
* __/usr/bin/traceroute6.iputils__ = _cap_net_raw+ep_
* __/usr/bin/mtr-packet__ = _cap_net_raw+ep_

<img width="1161" height="275" alt="6" src="https://github.com/user-attachments/assets/d2cf87a6-7a21-4988-a01f-d0af620a9b9f" />

The first binary immediately stood out: __python3.8__ with __cap_setuid__.

* __cap_setuid__: Allows the process to change its user ID arbitrarily
* __cap_net_bind_service__: Allows binding to network ports below 1024
* __eip (Effective, Inheritable, Permitted)__: The capability is active when the program runs, can be passed to child processes, and is permitted for use by this process

From [___GTFOBins___](https://gtfobins.github.io/gtfobins/python/#capabilities):

_"If the binary has the Linux `CAP_SETUID` capability set or it is executed by another binary with the capability set, it can be used as a backdoor to maintain privileged access by manipulating its own process UID."_

With this information, I used the Python interpreter to import the `os` module, set the process UID to 0, and spawn a root shell.

<img width="1024" height="213" alt="7" src="https://github.com/user-attachments/assets/d2cd10eb-07a1-47e8-a013-f9ecaf3c034f" />

<!-- include commenting about the python code here and how it relates to the challenge overall, max 6 lines -->

Examining the application source code revealed why this capability was granted. The __/capture__ route needed root privileges to run `tcpdump` for packet capture. Rather than properly configuring service permissions, the developer granted `cap_setuid` to Python itself and invoked `os.setuid(0)` before executing the capture command.

This dangerous workaround was intended to solve permission issues with Gunicorn and threading, but instead created a privilege escalation vector. The capability remained on the Python binary system-wide, allowing any user to leverage it for arbitrary privilege escalationâ€”a textbook example of excessive permissions leading to system compromise.

### /capture route in app.py
```python
@app.route("/capture")
@limiter.limit("10 per minute")
def capture():

        get_lock()
        pcapid = get_appid()
        increment_appid()
        release_lock()

        path = os.path.join(app.root_path, "upload", str(pcapid) + ".pcap")
        ip = request.remote_addr
        # permissions issues with gunicorn and threads. hacky solution for now.
        #os.setuid(0)
        #command = f"timeout 5 tcpdump -w {path} -i any host {ip}"
        command = f"""python3 -c 'import os; os.setuid(0); os.system("timeout 5 tcpdump -w {path} -i any host {ip}")'"""
        os.system(command)
        #os.setuid(1000)

        return redirect("/data/" + str(pcapid))
```


## Conclusion

Cap demonstrated how weak access controls and misconfigured system capabilities can lead to complete system compromise:

* An IDOR vulnerability allowed unauthorized access to packet capture files containing sensitive data.
* Plaintext FTP credentials in network traffic enabled initial access via SSH.
* Misconfigured Linux capabilities on the Python binary facilitated privilege escalation to root.
